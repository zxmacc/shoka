<!-- build time:Fri Jun 11 2021 17:08:37 GMT+0800 (中国标准时间) --><!DOCTYPE html><html lang="zh-CN"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=2"><meta name="theme-color" content="#FFF"><link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png"><link rel="icon" type="image/ico" sizes="32x32" href="/images/favicon.ico"><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><link rel="alternate" type="application/rss+xml" title="檐牙的小窝" href="http://www.zxmacc.cf/rss.xml"><link rel="alternate" type="application/atom+xml" title="檐牙的小窝" href="http://www.zxmacc.cf/atom.xml"><link rel="alternate" type="application/json" title="檐牙的小窝" href="http://www.zxmacc.cf/feed.json"><link rel="stylesheet" href="//fonts.googleapis.com/css?family=Mulish:300,300italic,400,400italic,700,700italic%7CFredericka%20the%20Great:300,300italic,400,400italic,700,700italic%7CNoto%20Serif%20JP:300,300italic,400,400italic,700,700italic%7CNoto%20Serif%20SC:300,300italic,400,400italic,700,700italic%7CInconsolata:300,300italic,400,400italic,700,700italic&display=swap&subset=latin,latin-ext"><link rel="stylesheet" href="/css/app.css?v=0.2.5"><link rel="canonical" href="http://www.zxmacc.cf/sakura/"><title>| Yan ya = 檐牙的小窝 = 檐牙</title><meta name="generator" content="Hexo 5.4.0"></head><body itemscope itemtype="http://schema.org/WebPage"><div id="loading"><div class="cat"><div class="body"></div><div class="head"><div class="face"></div></div><div class="foot"><div class="tummy-end"></div><div class="bottom"></div><div class="legs left"></div><div class="legs right"></div></div><div class="paw"><div class="hands left"></div><div class="hands right"></div></div></div></div><div id="container"><header id="header" itemscope itemtype="http://schema.org/WPHeader"><div class="inner"><div id="brand"><div class="pjax"><h1 itemprop="name headline"></h1></div></div><nav id="nav"><div class="inner"><div class="toggle"><div class="lines" aria-label="切换导航栏"><span class="line"></span> <span class="line"></span> <span class="line"></span></div></div><ul class="menu"><li class="item title"><a href="/" rel="start">Yan ya</a></li></ul><ul class="right"><li class="item theme"><i class="ic i-sun"></i></li><li class="item search"><i class="ic i-search"></i></li></ul></div></nav></div><div id="imgs" class="pjax"><ul><li class="item" data-background-image="https://tva2.sinaimg.cn/large/6833939bly1giclize41wj20zk0m87gk.jpg"></li><li class="item" data-background-image="https://tva2.sinaimg.cn/large/6833939bly1gipeyhsblkj20zk0m81kx.jpg"></li><li class="item" data-background-image="https://tva2.sinaimg.cn/large/6833939bly1gipevgoki5j20zk0m84qp.jpg"></li><li class="item" data-background-image="https://tva2.sinaimg.cn/large/6833939bly1gicis3attqj20zk0m8k7l.jpg"></li><li class="item" data-background-image="https://tva2.sinaimg.cn/large/6833939bly1giclwuom7cj20zk0m8dvn.jpg"></li><li class="item" data-background-image="https://tva2.sinaimg.cn/large/6833939bly1giclxxcb6rj20zk0m8b29.jpg"></li></ul></div></header><div id="waves"><svg class="waves" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 24 150 28" preserveAspectRatio="none" shape-rendering="auto"><defs><path id="gentle-wave" d="M-160 44c30 0 58-18 88-18s 58 18 88 18 58-18 88-18 58 18 88 18 v44h-352z"/></defs><g class="parallax"><use xlink:href="#gentle-wave" x="48" y="0"/><use xlink:href="#gentle-wave" x="48" y="3"/><use xlink:href="#gentle-wave" x="48" y="5"/><use xlink:href="#gentle-wave" x="48" y="7"/></g></svg></div><main><div class="inner"><div id="main" class="pjax"><div class="page wrap"><article itemscope itemtype="http://schema.org/Article" class="post block" lang="zh-CN"><link itemprop="mainEntityOfPage" href="http://www.zxmacc.cf/sakura/index.html"><span hidden itemprop="author" itemscope itemtype="http://schema.org/Person"><meta itemprop="image" content="/images/avatar.jpg"><meta itemprop="name" content="檐牙"><meta itemprop="description" content="檐牙, 梦想是当一名画师"></span><span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization"><meta itemprop="name" content="檐牙的小窝"></span><div class="body md" itemprop="articleBody"><p>&lt;link rel=&quot;stylesheet&quot; class=&quot;aplayer-secondary-style-marker&quot; href=&quot;\assets\css\APlayer.min.css&quot;&gt;&lt;script src=&quot;\assets\js\APlayer.min.js&quot; class=&quot;aplayer-secondary-script-marker&quot;&gt;&lt;/script&gt;&lt;script class=&quot;meting-secondary-script-marker&quot; src=&quot;\assets\js\Meting.min.js&quot;&gt;&lt;/script&gt;&lt;link rel=&quot;stylesheet&quot; type=&quot;text/css&quot; href=&quot;<span class="exturl" data-url="aHR0cHM6Ly9jZG4uanNkZWxpdnIubmV0L2hpbnQuY3NzLzIuNC4xL2hpbnQubWluLmNzcw==">https://cdn.jsdelivr.net/hint.css/2.4.1/hint.min.css</span>&quot;&gt;&lt;!DOCTYPE html&gt;<br>&lt;html xmlns=&quot;<span class="exturl" data-url="aHR0cDovL3d3dy53My5vcmcvMTk5OS94aHRtbA==">http://www.w3.org/1999/xhtml</span>&quot; xml:lang=&quot;en&quot; lang=&quot;en&quot;&gt;&lt;head&gt;&lt;meta http-equiv=&quot;Content-Type&quot; content=&quot;text/html; charset=UTF-8&quot;&gt;</p><p>&lt;head&gt;<br>&lt;title&gt; 送你一场樱花雨，原作者:xiabor.com&lt;/title&gt;</p><p>&lt;meta name=&quot;generator&quot; content=&quot;Hexo 4.2.0&quot;&gt;&lt;link rel=&quot;alternate&quot; href=&quot;/atom.xml&quot; title=&quot;MuJin's Blog&quot; type=&quot;application/atom+xml&quot;&gt;<br>&lt;link rel=&quot;alternate&quot; href=&quot;/rss2.xml&quot; title=&quot;MuJin's Blog&quot; type=&quot;application/rss+xml&quot;&gt;<br>&lt;/head&gt;</p><p>&lt;body&gt;</p><p>&lt;!-- 背景 --&gt;<br>&lt;p&gt;&lt;canvas id=&quot;sakura&quot; style=&quot; position: absolute ;z-index: 1&quot; width=&quot;1349&quot; height=&quot;638&quot;&gt;&lt;/canvas&gt;&lt;/p&gt;<br>&lt;div style=&quot;position: absolute ;z-index: 9999&quot; id=&quot;mainDiv&quot;&gt;</p><p>&lt;div id=&quot;loveu&quot; style=&quot;display: block;&quot;&gt;&lt;/br&gt;&lt;/br&gt;&lt;/br&gt;&lt;/br&gt;</p><p>&lt;/div&gt;</p><p>&lt;p align=&quot;left&quot;&gt;      Wait a second,please&lt;/p&gt;<br>&lt;p align=&quot;left&quot;&gt;      (≧ω≦) 马上就下樱花雨了...&lt;/p&gt;<br>&lt;p&gt;      你可以关闭下方的自动播放，或 &lt; a href=https://www.zxmacc.ga &gt; 点击此处 &lt;/a &gt; 返回首页 &lt;/p&gt;<br><br>&lt;script type=&quot;text/javascript&quot;&gt;</p><p>&lt;pre&gt;&lt;code&gt;var offsetX = $(&quot;#loveHeart&quot;).width() / 2;</p><p>var offsetY = $(&quot;#loveHeart&quot;).height() / 2 - 55;</p><p>var together = new Date();</p><p>together.setFullYear(1996, 6,24 );</p><p>together.setHours(20);</p><p>together.setMinutes(0);</p><p>together.setSeconds(0);</p><p>together.setMilliseconds(0);</p><p>if (!document.createElement('canvas').getContext) {</p><pre><code>var msg = document.createElement(&amp;quot;div&amp;quot;);

msg.id = &amp;quot;errorMsg&amp;quot;;

msg.innerHTML = &amp;quot;Your browser doesn&amp;apos;t support HTML5!&amp;lt;br/&amp;gt;Recommend use Chrome 14+/IE 9+/Firefox 7+/Safari 4+&amp;quot;;

document.body.appendChild(msg);

$(&amp;quot;#code&amp;quot;).css(&amp;quot;display&amp;quot;, &amp;quot;none&amp;quot;)

$(&amp;quot;#copyright&amp;quot;).css(&amp;quot;position&amp;quot;, &amp;quot;absolute&amp;quot;);

$(&amp;quot;#copyright&amp;quot;).css(&amp;quot;bottom&amp;quot;, &amp;quot;10px&amp;quot;);

document.execCommand(&amp;quot;stop&amp;quot;);
</code></pre><p>} else {</p><pre><code>setTimeout(function () &#123;

    startHeartAnimation();

&#125;, 5000);



timeElapse(together);

setInterval(function () &#123;

    timeElapse(together);

&#125;, 500);



adjustCodePosition();

$(&amp;quot;#code&amp;quot;).typewriter();
</code></pre><p>}&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;&lt;/script&gt;&lt;/p&gt;<br>&lt;script id=&quot;sakura_point_vsh&quot; type=&quot;x-shader/x_vertex&quot;&gt;</p><p>uniform mat4 uProjection;</p><p>uniform mat4 uModelview;</p><p>uniform vec3 uResolution;</p><p>uniform vec3 uOffset;</p><p>uniform vec3 uDOF; //x:focus distance, y:focus radius, z:max radius</p><p>uniform vec3 uFade; //x:start distance, y:half distance, z:near fade start</p><p>attribute vec3 aPosition;</p><p>attribute vec3 aEuler;</p><p>attribute vec2 aMisc; //x:size, y:fade</p><p>varying vec3 pposition;</p><p>varying float psize;</p><p>varying float palpha;</p><p>varying float pdist;</p><p>//varying mat3 rotMat;</p><p>varying vec3 normX;</p><p>varying vec3 normY;</p><p>varying vec3 normZ;</p><p>varying vec3 normal;</p><p>varying float diffuse;</p><p>varying float specular;</p><p>varying float rstop;</p><p>varying float distancefade;</p><p>void main(void) {</p><pre><code>// Projection is based on vertical angle

vec4 pos = uModelview * vec4(aPosition + uOffset, 1.0);

gl_Position = uProjection * pos;

gl_PointSize = aMisc.x * uProjection[1][1] / -pos.z * uResolution.y * 0.5;



pposition = pos.xyz;

psize = aMisc.x;

pdist = length(pos.xyz);

palpha = smoothstep(0.0, 1.0, (pdist - 0.1) / uFade.z);



vec3 elrsn = sin(aEuler);

vec3 elrcs = cos(aEuler);

mat3 rotx = mat3(

    1.0, 0.0, 0.0,

    0.0, elrcs.x, elrsn.x,

    0.0, -elrsn.x, elrcs.x

);

mat3 roty = mat3(

    elrcs.y, 0.0, -elrsn.y,

    0.0, 1.0, 0.0,

    elrsn.y, 0.0, elrcs.y

);

mat3 rotz = mat3(

    elrcs.z, elrsn.z, 0.0,

    -elrsn.z, elrcs.z, 0.0,

    0.0, 0.0, 1.0

);

mat3 rotmat = rotx * roty * rotz;

normal = rotmat[2];



mat3 trrotm = mat3(

    rotmat[0][0], rotmat[1][0], rotmat[2][0],

    rotmat[0][1], rotmat[1][1], rotmat[2][1],

    rotmat[0][2], rotmat[1][2], rotmat[2][2]

);

normX = trrotm[0];

normY = trrotm[1];

normZ = trrotm[2];



const vec3 lit = vec3(0.6917144638660746, 0.6917144638660746, -0.20751433915982237);



float tmpdfs = dot(lit, normal);

if(tmpdfs &lt; 0.0) &#123;

    normal = -normal;

    tmpdfs = dot(lit, normal);

&#125;

diffuse = 0.4 + tmpdfs;



vec3 eyev = normalize(-pos.xyz);

if(dot(eyev, normal) &gt; 0.0) &#123;

    vec3 hv = normalize(eyev + lit);

    specular = pow(max(dot(hv, normal), 0.0), 20.0);

&#125;

else &#123;

    specular = 0.0;

&#125;



rstop = clamp((abs(pdist - uDOF.x) - uDOF.y) / uDOF.z, 0.0, 1.0);

rstop = pow(rstop, 0.5);

//-0.69315 = ln(0.5)

distancefade = min(1.0, exp((uFade.x - pdist) * 0.69315 / uFade.y));
</code></pre><p>}</p><p>&lt;/script&gt;</p><p>&lt;script id=&quot;sakura_point_fsh&quot; type=&quot;x-shader/x_fragment&quot;&gt;</p><p>#ifdef GL_ES</p><p>//precision mediump float;</p><p>precision highp float;</p><p>#endif</p><p>uniform vec3 uDOF; //x:focus distance, y:focus radius, z:max radius</p><p>uniform vec3 uFade; //x:start distance, y:half distance, z:near fade start</p><p>const vec3 fadeCol = vec3(0.08, 0.03, 0.06);</p><p>varying vec3 pposition;</p><p>varying float psize;</p><p>varying float palpha;</p><p>varying float pdist;</p><p>//varying mat3 rotMat;</p><p>varying vec3 normX;</p><p>varying vec3 normY;</p><p>varying vec3 normZ;</p><p>varying vec3 normal;</p><p>varying float diffuse;</p><p>varying float specular;</p><p>varying float rstop;</p><p>varying float distancefade;</p><p>float ellipse(vec2 p, vec2 o, vec2 r) {</p><pre><code>vec2 lp = (p - o) / r;

return length(lp) - 1.0;
</code></pre><p>}</p><p>void main(void) {</p><pre><code>vec3 p = vec3(gl_PointCoord - vec2(0.5, 0.5), 0.0) * 2.0;

vec3 d = vec3(0.0, 0.0, -1.0);

float nd = normZ.z; //dot(-normZ, d);

if(abs(nd) &lt; 0.0001) discard;



float np = dot(normZ, p);

vec3 tp = p + d * np / nd;

vec2 coord = vec2(dot(normX, tp), dot(normY, tp));



//angle = 15 degree

const float flwrsn = 0.258819045102521;

const float flwrcs = 0.965925826289068;

mat2 flwrm = mat2(flwrcs, -flwrsn, flwrsn, flwrcs);

vec2 flwrp = vec2(abs(coord.x), coord.y) * flwrm;



float r;

if(flwrp.x &lt; 0.0) &#123;

    r = ellipse(flwrp, vec2(0.065, 0.024) * 0.5, vec2(0.36, 0.96) * 0.5);

&#125;

else &#123;

    r = ellipse(flwrp, vec2(0.065, 0.024) * 0.5, vec2(0.58, 0.96) * 0.5);

&#125;



if(r &gt; rstop) discard;



vec3 col = mix(vec3(1.0, 0.8, 0.75), vec3(1.0, 0.9, 0.87), r);

float grady = mix(0.0, 1.0, pow(coord.y * 0.5 + 0.5, 0.35));

col *= vec3(1.0, grady, grady);

col *= mix(0.8, 1.0, pow(abs(coord.x), 0.3));

col = col * diffuse + specular;



col = mix(fadeCol, col, distancefade);



float alpha = (rstop &gt; 0.001)? (0.5 - r / (rstop * 2.0)) : 1.0;

alpha = smoothstep(0.0, 1.0, alpha) * palpha;



gl_FragColor = vec4(col * 0.5, alpha);
</code></pre><p>}</p><p>&lt;/script&gt;</p><p>&lt;!-- effects --&gt;</p><p>&lt;script id=&quot;fx_common_vsh&quot; type=&quot;x-shader/x_vertex&quot;&gt;</p><p>uniform vec3 uResolution;</p><p>attribute vec2 aPosition;</p><p>varying vec2 texCoord;</p><p>varying vec2 screenCoord;</p><p>void main(void) {</p><pre><code>gl_Position = vec4(aPosition, 0.0, 1.0);

texCoord = aPosition.xy * 0.5 + vec2(0.5, 0.5);

screenCoord = aPosition.xy * vec2(uResolution.z, 1.0);
</code></pre><p>}</p><p>&lt;/script&gt;</p><p>&lt;script id=&quot;bg_fsh&quot; type=&quot;x-shader/x_fragment&quot;&gt;</p><p>#ifdef GL_ES</p><p>//precision mediump float;</p><p>precision highp float;</p><p>#endif</p><p>uniform vec2 uTimes;</p><p>varying vec2 texCoord;</p><p>varying vec2 screenCoord;</p><p>void main(void) {</p><pre><code>vec3 col;

float c;

vec2 tmpv = texCoord * vec2(0.8, 1.0) - vec2(0.95, 1.0);

c = exp(-pow(length(tmpv) * 1.8, 2.0));

col = mix(vec3(0.02, 0.0, 0.03), vec3(0.96, 0.98, 1.0) * 1.5, c);

gl_FragColor = vec4(col * 0.5, 1.0);
</code></pre><p>}</p><p>&lt;/script&gt;</p><p>&lt;script id=&quot;fx_brightbuf_fsh&quot; type=&quot;x-shader/x_fragment&quot;&gt;</p><p>#ifdef GL_ES</p><p>//precision mediump float;</p><p>precision highp float;</p><p>#endif</p><p>uniform sampler2D uSrc;</p><p>uniform vec2 uDelta;</p><p>varying vec2 texCoord;</p><p>varying vec2 screenCoord;</p><p>void main(void) {</p><pre><code>vec4 col = texture2D(uSrc, texCoord);

gl_FragColor = vec4(col.rgb * 2.0 - vec3(0.5), 1.0);
</code></pre><p>}</p><p>&lt;/script&gt;</p><p>&lt;script id=&quot;fx_dirblur_r4_fsh&quot; type=&quot;x-shader/x_fragment&quot;&gt;</p><p>#ifdef GL_ES</p><p>//precision mediump float;</p><p>precision highp float;</p><p>#endif</p><p>uniform sampler2D uSrc;</p><p>uniform vec2 uDelta;</p><p>uniform vec4 uBlurDir; //dir(x, y), stride(z, w)</p><p>varying vec2 texCoord;</p><p>varying vec2 screenCoord;</p><p>void main(void) {</p><pre><code>vec4 col = texture2D(uSrc, texCoord);

col = col + texture2D(uSrc, texCoord + uBlurDir.xy * uDelta);

col = col + texture2D(uSrc, texCoord - uBlurDir.xy * uDelta);

col = col + texture2D(uSrc, texCoord + (uBlurDir.xy + uBlurDir.zw) * uDelta);

col = col + texture2D(uSrc, texCoord - (uBlurDir.xy + uBlurDir.zw) * uDelta);

gl_FragColor = col / 5.0;
</code></pre><p>}</p><p>&lt;/script&gt;</p><p>&lt;!-- effect fragment shader template --&gt;</p><p>&lt;script id=&quot;fx_common_fsh&quot; type=&quot;x-shader/x_fragment&quot;&gt;</p><p>#ifdef GL_ES</p><p>//precision mediump float;</p><p>precision highp float;</p><p>#endif</p><p>uniform sampler2D uSrc;</p><p>uniform vec2 uDelta;</p><p>varying vec2 texCoord;</p><p>varying vec2 screenCoord;</p><p>void main(void) {</p><pre><code>gl_FragColor = texture2D(uSrc, texCoord);
</code></pre><p>}</p><p>&lt;/script&gt;</p><p>&lt;!-- post processing --&gt;</p><p>&lt;script id=&quot;pp_final_vsh&quot; type=&quot;x-shader/x_vertex&quot;&gt;</p><p>uniform vec3 uResolution;</p><p>attribute vec2 aPosition;</p><p>varying vec2 texCoord;</p><p>varying vec2 screenCoord;</p><p>void main(void) {</p><pre><code>gl_Position = vec4(aPosition, 0.0, 1.0);

texCoord = aPosition.xy * 0.5 + vec2(0.5, 0.5);

screenCoord = aPosition.xy * vec2(uResolution.z, 1.0);
</code></pre><p>}</p><p>&lt;/script&gt;</p><p>&lt;script id=&quot;pp_final_fsh&quot; type=&quot;x-shader/x_fragment&quot;&gt;</p><p>#ifdef GL_ES</p><p>//precision mediump float;</p><p>precision highp float;</p><p>#endif</p><p>uniform sampler2D uSrc;</p><p>uniform sampler2D uBloom;</p><p>uniform vec2 uDelta;</p><p>varying vec2 texCoord;</p><p>varying vec2 screenCoord;</p><p>void main(void) {</p><pre><code>vec4 srccol = texture2D(uSrc, texCoord) * 2.0;

vec4 bloomcol = texture2D(uBloom, texCoord);

vec4 col;

col = srccol + bloomcol * (vec4(1.0) + srccol);

col *= smoothstep(1.0, 0.0, pow(length((texCoord - vec2(0.5)) * 2.0), 1.2) * 0.5);

col = pow(col, vec4(0.45454545454545)); //(1.0 / 2.2)



gl_FragColor = vec4(col.rgb, 1.0);

gl_FragColor.a = 1.0;
</code></pre><p>}</p><p>&lt;/script&gt;</p><p>&lt;script&gt;</p><pre><code>// Utilities

var Vector3 = &#123;&#125;;

var Matrix44 = &#123;&#125;;

Vector3.create = function(x, y, z) &#123;

    return &#123;'x':x, 'y':y, 'z':z&#125;;

&#125;;

Vector3.dot = function (v0, v1) &#123;

    return v0.x * v1.x + v0.y * v1.y + v0.z * v1.z;

&#125;;

Vector3.cross = function (v, v0, v1) &#123;

    v.x = v0.y * v1.z - v0.z * v1.y;

    v.y = v0.z * v1.x - v0.x * v1.z;

    v.z = v0.x * v1.y - v0.y * v1.x;

&#125;;

Vector3.normalize = function (v) &#123;

    var l = v.x * v.x + v.y * v.y + v.z * v.z;

    if(l &gt; 0.00001) &#123;

        l = 1.0 / Math.sqrt(l);

        v.x *= l;

        v.y *= l;

        v.z *= l;

    &#125;

&#125;;

Vector3.arrayForm = function(v) &#123;

    if(v.array) &#123;

        v.array[0] = v.x;

        v.array[1] = v.y;

        v.array[2] = v.z;

    &#125;

    else &#123;

        v.array = new Float32Array([v.x, v.y, v.z]);

    &#125;

    return v.array;

&#125;;

Matrix44.createIdentity = function () &#123;

    return new Float32Array([1.0, 0.0, 0.0, 0.0, 0.0, 1.0, 0.0, 0.0, 0.0, 0.0, 1.0, 0.0, 0.0, 0.0, 0.0, 1.0]);

&#125;;

Matrix44.loadProjection = function (m, aspect, vdeg, near, far) &#123;

    var h = near * Math.tan(vdeg * Math.PI / 180.0 * 0.5) * 2.0;

    var w = h * aspect;



    m[0] = 2.0 * near / w;

    m[1] = 0.0;

    m[2] = 0.0;

    m[3] = 0.0;



    m[4] = 0.0;

    m[5] = 2.0 * near / h;

    m[6] = 0.0;

    m[7] = 0.0;



    m[8] = 0.0;

    m[9] = 0.0;

    m[10] = -(far + near) / (far - near);

    m[11] = -1.0;



    m[12] = 0.0;

    m[13] = 0.0;

    m[14] = -2.0 * far * near / (far - near);

    m[15] = 0.0;

&#125;;

Matrix44.loadLookAt = function (m, vpos, vlook, vup) &#123;

    var frontv = Vector3.create(vpos.x - vlook.x, vpos.y - vlook.y, vpos.z - vlook.z);

    Vector3.normalize(frontv);

    var sidev = Vector3.create(1.0, 0.0, 0.0);

    Vector3.cross(sidev, vup, frontv);

    Vector3.normalize(sidev);

    var topv = Vector3.create(1.0, 0.0, 0.0);

    Vector3.cross(topv, frontv, sidev);

    Vector3.normalize(topv);



    m[0] = sidev.x;

    m[1] = topv.x;

    m[2] = frontv.x;

    m[3] = 0.0;



    m[4] = sidev.y;

    m[5] = topv.y;

    m[6] = frontv.y;

    m[7] = 0.0;



    m[8] = sidev.z;

    m[9] = topv.z;

    m[10] = frontv.z;

    m[11] = 0.0;



    m[12] = -(vpos.x * m[0] + vpos.y * m[4] + vpos.z * m[8]);

    m[13] = -(vpos.x * m[1] + vpos.y * m[5] + vpos.z * m[9]);

    m[14] = -(vpos.x * m[2] + vpos.y * m[6] + vpos.z * m[10]);

    m[15] = 1.0;

&#125;;



//

var timeInfo = &#123;

    'start':0, 'prev':0, // Date

    'delta':0, 'elapsed':0 // Number(sec)

&#125;;



//

var gl;

var renderSpec = &#123;

    'width':0,

    'height':0,

    'aspect':1,

    'array':new Float32Array(3),

    'halfWidth':0,

    'halfHeight':0,

    'halfArray':new Float32Array(3)

    // and some render targets. see setViewport()

&#125;;

renderSpec.setSize = function(w, h) &#123;

    renderSpec.width = w;

    renderSpec.height = h;

    renderSpec.aspect = renderSpec.width / renderSpec.height;

    renderSpec.array[0] = renderSpec.width;

    renderSpec.array[1] = renderSpec.height;

    renderSpec.array[2] = renderSpec.aspect;



    renderSpec.halfWidth = Math.floor(w / 2);

    renderSpec.halfHeight = Math.floor(h / 2);

    renderSpec.halfArray[0] = renderSpec.halfWidth;

    renderSpec.halfArray[1] = renderSpec.halfHeight;

    renderSpec.halfArray[2] = renderSpec.halfWidth / renderSpec.halfHeight;

&#125;;



function deleteRenderTarget(rt) &#123;

    gl.deleteFramebuffer(rt.frameBuffer);

    gl.deleteRenderbuffer(rt.renderBuffer);

    gl.deleteTexture(rt.texture);

&#125;



function createRenderTarget(w, h) &#123;

    var ret = &#123;

        'width':w,

        'height':h,

        'sizeArray':new Float32Array([w, h, w / h]),

        'dtxArray':new Float32Array([1.0 / w, 1.0 / h])

    &#125;;

    ret.frameBuffer = gl.createFramebuffer();

    ret.renderBuffer = gl.createRenderbuffer();

    ret.texture = gl.createTexture();



    gl.bindTexture(gl.TEXTURE_2D, ret.texture);

    gl.texImage2D(gl.TEXTURE_2D, 0, gl.RGBA, w, h, 0, gl.RGBA, gl.UNSIGNED_BYTE, null);

    gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_WRAP_S, gl.CLAMP_TO_EDGE);

    gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_WRAP_T, gl.CLAMP_TO_EDGE);

    gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_MAG_FILTER, gl.LINEAR);

    gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_MIN_FILTER, gl.LINEAR);



    gl.bindFramebuffer(gl.FRAMEBUFFER, ret.frameBuffer);

    gl.framebufferTexture2D(gl.FRAMEBUFFER, gl.COLOR_ATTACHMENT0, gl.TEXTURE_2D, ret.texture, 0);



    gl.bindRenderbuffer(gl.RENDERBUFFER, ret.renderBuffer);

    gl.renderbufferStorage(gl.RENDERBUFFER, gl.DEPTH_COMPONENT16, w, h);

    gl.framebufferRenderbuffer(gl.FRAMEBUFFER, gl.DEPTH_ATTACHMENT, gl.RENDERBUFFER, ret.renderBuffer);



    gl.bindTexture(gl.TEXTURE_2D, null);

    gl.bindRenderbuffer(gl.RENDERBUFFER, null);

    gl.bindFramebuffer(gl.FRAMEBUFFER, null);



    return ret;

&#125;



function compileShader(shtype, shsrc) &#123;

    var retsh = gl.createShader(shtype);



    gl.shaderSource(retsh, shsrc);

    gl.compileShader(retsh);



    if(!gl.getShaderParameter(retsh, gl.COMPILE_STATUS)) &#123;

        var errlog = gl.getShaderInfoLog(retsh);

        gl.deleteShader(retsh);

        console.error(errlog);

        return null;

    &#125;

    return retsh;

&#125;



function createShader(vtxsrc, frgsrc, uniformlist, attrlist) &#123;

    var vsh = compileShader(gl.VERTEX_SHADER, vtxsrc);

    var fsh = compileShader(gl.FRAGMENT_SHADER, frgsrc);



    if(vsh == null || fsh == null) &#123;

        return null;

    &#125;



    var prog = gl.createProgram();

    gl.attachShader(prog, vsh);

    gl.attachShader(prog, fsh);



    gl.deleteShader(vsh);

    gl.deleteShader(fsh);



    gl.linkProgram(prog);

    if (!gl.getProgramParameter(prog, gl.LINK_STATUS)) &#123;

        var errlog = gl.getProgramInfoLog(prog);

        console.error(errlog);

        return null;

    &#125;



    if(uniformlist) &#123;

        prog.uniforms = &#123;&#125;;

        for(var i = 0; i &lt; uniformlist.length; i++) &#123;

            prog.uniforms[uniformlist[i]] = gl.getUniformLocation(prog, uniformlist[i]);

        &#125;

    &#125;



    if(attrlist) &#123;

        prog.attributes = &#123;&#125;;

        for(var i = 0; i &lt; attrlist.length; i++) &#123;

            var attr = attrlist[i];

            prog.attributes[attr] = gl.getAttribLocation(prog, attr);

        &#125;

    &#125;



    return prog;

&#125;



function useShader(prog) &#123;

    gl.useProgram(prog);

    for(var attr in prog.attributes) &#123;

        gl.enableVertexAttribArray(prog.attributes[attr]);;

    &#125;

&#125;



function unuseShader(prog) &#123;

    for(var attr in prog.attributes) &#123;

        gl.disableVertexAttribArray(prog.attributes[attr]);;

    &#125;

    gl.useProgram(null);

&#125;



/////

var projection = &#123;

    'angle':60,

    'nearfar':new Float32Array([0.1, 100.0]),

    'matrix':Matrix44.createIdentity()

&#125;;

var camera = &#123;

    'position':Vector3.create(0, 0, 100),

    'lookat':Vector3.create(0, 0, 0),

    'up':Vector3.create(0, 1, 0),

    'dof':Vector3.create(10.0, 4.0, 8.0),

    'matrix':Matrix44.createIdentity()

&#125;;



var pointFlower = &#123;&#125;;

var meshFlower = &#123;&#125;;

var sceneStandBy = false;



var BlossomParticle = function () &#123;

    this.velocity = new Array(3);

    this.rotation = new Array(3);

    this.position = new Array(3);

    this.euler = new Array(3);

    this.size = 1.0;

    this.alpha = 1.0;

    this.zkey = 0.0;

&#125;;



BlossomParticle.prototype.setVelocity = function (vx, vy, vz) &#123;

    this.velocity[0] = vx;

    this.velocity[1] = vy;

    this.velocity[2] = vz;

&#125;;



BlossomParticle.prototype.setRotation = function (rx, ry, rz) &#123;

    this.rotation[0] = rx;

    this.rotation[1] = ry;

    this.rotation[2] = rz;

&#125;;



BlossomParticle.prototype.setPosition = function (nx, ny, nz) &#123;

    this.position[0] = nx;

    this.position[1] = ny;

    this.position[2] = nz;

&#125;;



BlossomParticle.prototype.setEulerAngles = function (rx, ry, rz) &#123;

    this.euler[0] = rx;

    this.euler[1] = ry;

    this.euler[2] = rz;

&#125;;



BlossomParticle.prototype.setSize = function (s) &#123;

    this.size = s;

&#125;;



BlossomParticle.prototype.update = function (dt, et) &#123;

    this.position[0] += this.velocity[0] * dt;

    this.position[1] += this.velocity[1] * dt;

    this.position[2] += this.velocity[2] * dt;



    this.euler[0] += this.rotation[0] * dt;

    this.euler[1] += this.rotation[1] * dt;

    this.euler[2] += this.rotation[2] * dt;

&#125;;



function createPointFlowers() &#123;

    // get point sizes

    var prm = gl.getParameter(gl.ALIASED_POINT_SIZE_RANGE);

    renderSpec.pointSize = &#123;'min':prm[0], 'max':prm[1]&#125;;



    var vtxsrc = document.getElementById(&quot;sakura_point_vsh&quot;).textContent;

    var frgsrc = document.getElementById(&quot;sakura_point_fsh&quot;).textContent;



    pointFlower.program = createShader(

            vtxsrc, frgsrc,

            ['uProjection', 'uModelview', 'uResolution', 'uOffset', 'uDOF', 'uFade'],

            ['aPosition', 'aEuler', 'aMisc']

    );



    useShader(pointFlower.program);

    pointFlower.offset = new Float32Array([0.0, 0.0, 0.0]);

    pointFlower.fader = Vector3.create(0.0, 10.0, 0.0);



    // paramerters: velocity[3], rotate[3]

    pointFlower.numFlowers = 1600;

    pointFlower.particles = new Array(pointFlower.numFlowers);

    // vertex attributes &#123;position[3], euler_xyz[3], size[1]&#125;

    pointFlower.dataArray = new Float32Array(pointFlower.numFlowers * (3 + 3 + 2));

    pointFlower.positionArrayOffset = 0;

    pointFlower.eulerArrayOffset = pointFlower.numFlowers * 3;

    pointFlower.miscArrayOffset = pointFlower.numFlowers * 6;



    pointFlower.buffer = gl.createBuffer();

    gl.bindBuffer(gl.ARRAY_BUFFER, pointFlower.buffer);

    gl.bufferData(gl.ARRAY_BUFFER, pointFlower.dataArray, gl.DYNAMIC_DRAW);

    gl.bindBuffer(gl.ARRAY_BUFFER, null);



    unuseShader(pointFlower.program);



    for(var i = 0; i &lt; pointFlower.numFlowers; i++) &#123;

        pointFlower.particles[i] = new BlossomParticle();

    &#125;

&#125;



function initPointFlowers() &#123;

    //area

    pointFlower.area = Vector3.create(20.0, 20.0, 20.0);

    pointFlower.area.x = pointFlower.area.y * renderSpec.aspect;



    pointFlower.fader.x = 10.0; //env fade start

    pointFlower.fader.y = pointFlower.area.z; //env fade half

    pointFlower.fader.z = 0.1;  //near fade start



    //particles

    var PI2 = Math.PI * 2.0;

    var tmpv3 = Vector3.create(0, 0, 0);

    var tmpv = 0;

    var symmetryrand = function() &#123;return (Math.random() * 2.0 - 1.0);&#125;;

    for(var i = 0; i &lt; pointFlower.numFlowers; i++) &#123;

        var tmpprtcl = pointFlower.particles[i];



        //velocity

        tmpv3.x = symmetryrand() * 0.3 + 0.8;

        tmpv3.y = symmetryrand() * 0.2 - 1.0;

        tmpv3.z = symmetryrand() * 0.3 + 0.5;

        Vector3.normalize(tmpv3);

        tmpv = 2.0 + Math.random() * 1.0;

        tmpprtcl.setVelocity(tmpv3.x * tmpv, tmpv3.y * tmpv, tmpv3.z * tmpv);



        //rotation

        tmpprtcl.setRotation(

                symmetryrand() * PI2 * 0.5,

                symmetryrand() * PI2 * 0.5,

                symmetryrand() * PI2 * 0.5

        );



        //position

        tmpprtcl.setPosition(

                symmetryrand() * pointFlower.area.x,

                symmetryrand() * pointFlower.area.y,

                symmetryrand() * pointFlower.area.z

        );



        //euler

        tmpprtcl.setEulerAngles(

                Math.random() * Math.PI * 2.0,

                Math.random() * Math.PI * 2.0,

                Math.random() * Math.PI * 2.0

        );



        //size

        tmpprtcl.setSize(0.9 + Math.random() * 0.1);

    &#125;

&#125;



function renderPointFlowers() &#123;

    //update

    var PI2 = Math.PI * 2.0;

    var limit = [pointFlower.area.x, pointFlower.area.y, pointFlower.area.z];

    var repeatPos = function (prt, cmp, limit) &#123;

        if(Math.abs(prt.position[cmp]) - prt.size * 0.5 &gt; limit) &#123;

            //out of area

            if(prt.position[cmp] &gt; 0) &#123;

                prt.position[cmp] -= limit * 2.0;

            &#125;

            else &#123;

                prt.position[cmp] += limit * 2.0;

            &#125;

        &#125;

    &#125;;

    var repeatEuler = function (prt, cmp) &#123;

        prt.euler[cmp] = prt.euler[cmp] % PI2;

        if(prt.euler[cmp] &lt; 0.0) &#123;

            prt.euler[cmp] += PI2;

        &#125;

    &#125;;



    for(var i = 0; i &lt; pointFlower.numFlowers; i++) &#123;

        var prtcl = pointFlower.particles[i];

        prtcl.update(timeInfo.delta, timeInfo.elapsed);

        repeatPos(prtcl, 0, pointFlower.area.x);

        repeatPos(prtcl, 1, pointFlower.area.y);

        repeatPos(prtcl, 2, pointFlower.area.z);

        repeatEuler(prtcl, 0);

        repeatEuler(prtcl, 1);

        repeatEuler(prtcl, 2);



        prtcl.alpha = 1.0;//(pointFlower.area.z - prtcl.position[2]) * 0.5;



        prtcl.zkey = (camera.matrix[2] * prtcl.position[0]

        + camera.matrix[6] * prtcl.position[1]

        + camera.matrix[10] * prtcl.position[2]

        + camera.matrix[14]);

    &#125;



    // sort

    pointFlower.particles.sort(function(p0, p1)&#123;return p0.zkey - p1.zkey;&#125;);



    // update data

    var ipos = pointFlower.positionArrayOffset;

    var ieuler = pointFlower.eulerArrayOffset;

    var imisc = pointFlower.miscArrayOffset;

    for(var i = 0; i &lt; pointFlower.numFlowers; i++) &#123;

        var prtcl = pointFlower.particles[i];

        pointFlower.dataArray[ipos] = prtcl.position[0];

        pointFlower.dataArray[ipos + 1] = prtcl.position[1];

        pointFlower.dataArray[ipos + 2] = prtcl.position[2];

        ipos += 3;

        pointFlower.dataArray[ieuler] = prtcl.euler[0];

        pointFlower.dataArray[ieuler + 1] = prtcl.euler[1];

        pointFlower.dataArray[ieuler + 2] = prtcl.euler[2];

        ieuler += 3;

        pointFlower.dataArray[imisc] = prtcl.size;

        pointFlower.dataArray[imisc + 1] = prtcl.alpha;

        imisc += 2;

    &#125;



    //draw

    gl.enable(gl.BLEND);

    //gl.disable(gl.DEPTH_TEST);

    gl.blendFunc(gl.SRC_ALPHA, gl.ONE_MINUS_SRC_ALPHA);



    var prog = pointFlower.program;

    useShader(prog);



    gl.uniformMatrix4fv(prog.uniforms.uProjection, false, projection.matrix);

    gl.uniformMatrix4fv(prog.uniforms.uModelview, false, camera.matrix);

    gl.uniform3fv(prog.uniforms.uResolution, renderSpec.array);

    gl.uniform3fv(prog.uniforms.uDOF, Vector3.arrayForm(camera.dof));

    gl.uniform3fv(prog.uniforms.uFade, Vector3.arrayForm(pointFlower.fader));



    gl.bindBuffer(gl.ARRAY_BUFFER, pointFlower.buffer);

    gl.bufferData(gl.ARRAY_BUFFER, pointFlower.dataArray, gl.DYNAMIC_DRAW);



    gl.vertexAttribPointer(prog.attributes.aPosition, 3, gl.FLOAT, false, 0, pointFlower.positionArrayOffset * Float32Array.BYTES_PER_ELEMENT);

    gl.vertexAttribPointer(prog.attributes.aEuler, 3, gl.FLOAT, false, 0, pointFlower.eulerArrayOffset * Float32Array.BYTES_PER_ELEMENT);

    gl.vertexAttribPointer(prog.attributes.aMisc, 2, gl.FLOAT, false, 0, pointFlower.miscArrayOffset * Float32Array.BYTES_PER_ELEMENT);



    // doubler

    for(var i = 1; i &lt; 2; i++) &#123;

        var zpos = i * -2.0;

        pointFlower.offset[0] = pointFlower.area.x * -1.0;

        pointFlower.offset[1] = pointFlower.area.y * -1.0;

        pointFlower.offset[2] = pointFlower.area.z * zpos;

        gl.uniform3fv(prog.uniforms.uOffset, pointFlower.offset);

        gl.drawArrays(gl.POINT, 0, pointFlower.numFlowers);



        pointFlower.offset[0] = pointFlower.area.x * -1.0;

        pointFlower.offset[1] = pointFlower.area.y *  1.0;

        pointFlower.offset[2] = pointFlower.area.z * zpos;

        gl.uniform3fv(prog.uniforms.uOffset, pointFlower.offset);

        gl.drawArrays(gl.POINT, 0, pointFlower.numFlowers);



        pointFlower.offset[0] = pointFlower.area.x *  1.0;

        pointFlower.offset[1] = pointFlower.area.y * -1.0;

        pointFlower.offset[2] = pointFlower.area.z * zpos;

        gl.uniform3fv(prog.uniforms.uOffset, pointFlower.offset);

        gl.drawArrays(gl.POINT, 0, pointFlower.numFlowers);



        pointFlower.offset[0] = pointFlower.area.x *  1.0;

        pointFlower.offset[1] = pointFlower.area.y *  1.0;

        pointFlower.offset[2] = pointFlower.area.z * zpos;

        gl.uniform3fv(prog.uniforms.uOffset, pointFlower.offset);

        gl.drawArrays(gl.POINT, 0, pointFlower.numFlowers);

    &#125;



    //main

    pointFlower.offset[0] = 0.0;

    pointFlower.offset[1] = 0.0;

    pointFlower.offset[2] = 0.0;

    gl.uniform3fv(prog.uniforms.uOffset, pointFlower.offset);

    gl.drawArrays(gl.POINT, 0, pointFlower.numFlowers);



    gl.bindBuffer(gl.ARRAY_BUFFER, null);

    unuseShader(prog);



    gl.enable(gl.DEPTH_TEST);

    gl.disable(gl.BLEND);

&#125;



// effects

//common util

function createEffectProgram(vtxsrc, frgsrc, exunifs, exattrs) &#123;

    var ret = &#123;&#125;;

    var unifs = ['uResolution', 'uSrc', 'uDelta'];

    if(exunifs) &#123;

        unifs = unifs.concat(exunifs);

    &#125;

    var attrs = ['aPosition'];

    if(exattrs) &#123;

        attrs = attrs.concat(exattrs);

    &#125;



    ret.program = createShader(vtxsrc, frgsrc, unifs, attrs);

    useShader(ret.program);



    ret.dataArray = new Float32Array([

        -1.0, -1.0,

        1.0, -1.0,

        -1.0,  1.0,

        1.0,  1.0

    ]);

    ret.buffer = gl.createBuffer();

    gl.bindBuffer(gl.ARRAY_BUFFER, ret.buffer);

    gl.bufferData(gl.ARRAY_BUFFER, ret.dataArray, gl.STATIC_DRAW);



    gl.bindBuffer(gl.ARRAY_BUFFER, null);

    unuseShader(ret.program);



    return ret;

&#125;



// basic usage

// useEffect(prog, srctex(&#123;'texture':texid, 'dtxArray':(f32)[dtx, dty]&#125;)); //basic initialize

// gl.uniform**(...); //additional uniforms

// drawEffect()

// unuseEffect(prog)

// TEXTURE0 makes src

function useEffect(fxobj, srctex) &#123;

    var prog = fxobj.program;

    useShader(prog);

    gl.uniform3fv(prog.uniforms.uResolution, renderSpec.array);



    if(srctex != null) &#123;

        gl.uniform2fv(prog.uniforms.uDelta, srctex.dtxArray);

        gl.uniform1i(prog.uniforms.uSrc, 0);



        gl.activeTexture(gl.TEXTURE0);

        gl.bindTexture(gl.TEXTURE_2D, srctex.texture);

    &#125;

&#125;

function drawEffect(fxobj) &#123;

    gl.bindBuffer(gl.ARRAY_BUFFER, fxobj.buffer);

    gl.vertexAttribPointer(fxobj.program.attributes.aPosition, 2, gl.FLOAT, false, 0, 0);

    gl.drawArrays(gl.TRIANGLE_STRIP, 0, 4);

&#125;

function unuseEffect(fxobj) &#123;

    unuseShader(fxobj.program);

&#125;



var effectLib = &#123;&#125;;

function createEffectLib() &#123;



    var vtxsrc, frgsrc;

    //common

    var cmnvtxsrc = document.getElementById(&quot;fx_common_vsh&quot;).textContent;



    //background

    frgsrc = document.getElementById(&quot;bg_fsh&quot;).textContent;

    effectLib.sceneBg = createEffectProgram(cmnvtxsrc, frgsrc, ['uTimes'], null);



    // make brightpixels buffer

    frgsrc = document.getElementById(&quot;fx_brightbuf_fsh&quot;).textContent;

    effectLib.mkBrightBuf = createEffectProgram(cmnvtxsrc, frgsrc, null, null);



    // direction blur

    frgsrc = document.getElementById(&quot;fx_dirblur_r4_fsh&quot;).textContent;

    effectLib.dirBlur = createEffectProgram(cmnvtxsrc, frgsrc, ['uBlurDir'], null);



    //final composite

    vtxsrc = document.getElementById(&quot;pp_final_vsh&quot;).textContent;

    frgsrc = document.getElementById(&quot;pp_final_fsh&quot;).textContent;

    effectLib.finalComp = createEffectProgram(vtxsrc, frgsrc, ['uBloom'], null);

&#125;



// background

function createBackground() &#123;

    //console.log(&quot;create background&quot;);

&#125;

function initBackground() &#123;

    //console.log(&quot;init background&quot;);

&#125;

function renderBackground() &#123;

    gl.disable(gl.DEPTH_TEST);



    useEffect(effectLib.sceneBg, null);

    gl.uniform2f(effectLib.sceneBg.program.uniforms.uTimes, timeInfo.elapsed, timeInfo.delta);

    drawEffect(effectLib.sceneBg);

    unuseEffect(effectLib.sceneBg);



    gl.enable(gl.DEPTH_TEST);

&#125;



// post process

var postProcess = &#123;&#125;;

function createPostProcess() &#123;

    //console.log(&quot;create post process&quot;);

&#125;

function initPostProcess() &#123;

    //console.log(&quot;init post process&quot;);

&#125;



function renderPostProcess() &#123;

    gl.enable(gl.TEXTURE_2D);

    gl.disable(gl.DEPTH_TEST);

    var bindRT = function (rt, isclear) &#123;

        gl.bindFramebuffer(gl.FRAMEBUFFER, rt.frameBuffer);

        gl.viewport(0, 0, rt.width, rt.height);

        if(isclear) &#123;

            gl.clearColor(0, 0, 0, 0);

            gl.clear(gl.COLOR_BUFFER_BIT | gl.DEPTH_BUFFER_BIT);

        &#125;

    &#125;;



    //make bright buff

    bindRT(renderSpec.wHalfRT0, true);

    useEffect(effectLib.mkBrightBuf, renderSpec.mainRT);

    drawEffect(effectLib.mkBrightBuf);

    unuseEffect(effectLib.mkBrightBuf);



    // make bloom

    for(var i = 0; i &lt; 2; i++) &#123;

        var p = 1.5 + 1 * i;

        var s = 2.0 + 1 * i;

        bindRT(renderSpec.wHalfRT1, true);

        useEffect(effectLib.dirBlur, renderSpec.wHalfRT0);

        gl.uniform4f(effectLib.dirBlur.program.uniforms.uBlurDir, p, 0.0, s, 0.0);

        drawEffect(effectLib.dirBlur);

        unuseEffect(effectLib.dirBlur);



        bindRT(renderSpec.wHalfRT0, true);

        useEffect(effectLib.dirBlur, renderSpec.wHalfRT1);

        gl.uniform4f(effectLib.dirBlur.program.uniforms.uBlurDir, 0.0, p, 0.0, s);

        drawEffect(effectLib.dirBlur);

        unuseEffect(effectLib.dirBlur);

    &#125;



    //display

    gl.bindFramebuffer(gl.FRAMEBUFFER, null);

    gl.viewport(0, 0, renderSpec.width, renderSpec.height);

    gl.clear(gl.COLOR_BUFFER_BIT | gl.DEPTH_BUFFER_BIT);



    useEffect(effectLib.finalComp, renderSpec.mainRT);

    gl.uniform1i(effectLib.finalComp.program.uniforms.uBloom, 1);

    gl.activeTexture(gl.TEXTURE1);

    gl.bindTexture(gl.TEXTURE_2D, renderSpec.wHalfRT0.texture);

    drawEffect(effectLib.finalComp);

    unuseEffect(effectLib.finalComp);



    gl.enable(gl.DEPTH_TEST);

&#125;



/////

var SceneEnv = &#123;&#125;;

function createScene() &#123;

    createEffectLib();

    createBackground();

    createPointFlowers();

    createPostProcess();

    sceneStandBy = true;

&#125;



function initScene() &#123;

    initBackground();

    initPointFlowers();

    initPostProcess();



    //camera.position.z = 17.320508;

    camera.position.z = pointFlower.area.z + projection.nearfar[0];

    projection.angle = Math.atan2(pointFlower.area.y, camera.position.z + pointFlower.area.z) * 180.0 / Math.PI * 2.0;

    Matrix44.loadProjection(projection.matrix, renderSpec.aspect, projection.angle, projection.nearfar[0], projection.nearfar[1]);

&#125;



function renderScene() &#123;

    //draw

    Matrix44.loadLookAt(camera.matrix, camera.position, camera.lookat, camera.up);



    gl.enable(gl.DEPTH_TEST);



    //gl.bindFramebuffer(gl.FRAMEBUFFER, null);

    gl.bindFramebuffer(gl.FRAMEBUFFER, renderSpec.mainRT.frameBuffer);

    gl.viewport(0, 0, renderSpec.mainRT.width, renderSpec.mainRT.height);

    gl.clearColor(0.005, 0, 0.05, 0);

    gl.clear(gl.COLOR_BUFFER_BIT | gl.DEPTH_BUFFER_BIT);



    renderBackground();

    renderPointFlowers();

    renderPostProcess();

&#125;



/////

function onResize(e) &#123;

    makeCanvasFullScreen(document.getElementById(&quot;sakura&quot;));

    setViewports();

    if(sceneStandBy) &#123;

        initScene();

    &#125;

&#125;



function setViewports() &#123;

    renderSpec.setSize(gl.canvas.width, gl.canvas.height);



    gl.clearColor(0.2, 0.2, 0.5, 1.0);

    gl.viewport(0, 0, renderSpec.width, renderSpec.height);



    var rtfunc = function (rtname, rtw, rth) &#123;

        var rt = renderSpec[rtname];

        if(rt) deleteRenderTarget(rt);

        renderSpec[rtname] = createRenderTarget(rtw, rth);

    &#125;;

    rtfunc('mainRT', renderSpec.width, renderSpec.height);

    rtfunc('wFullRT0', renderSpec.width, renderSpec.height);

    rtfunc('wFullRT1', renderSpec.width, renderSpec.height);

    rtfunc('wHalfRT0', renderSpec.halfWidth, renderSpec.halfHeight);

    rtfunc('wHalfRT1', renderSpec.halfWidth, renderSpec.halfHeight);

&#125;



function render() &#123;

    renderScene();

&#125;



var animating = true;

function toggleAnimation(elm) &#123;

    animating ^= true;

    if(animating) animate();

    if(elm) &#123;

        elm.innerHTML = animating? &quot;Stop&quot;:&quot;Start&quot;;

    &#125;

&#125;



function stepAnimation() &#123;

    if(!animating) animate();

&#125;



function animate() &#123;

    var curdate = new Date();

    timeInfo.elapsed = (curdate - timeInfo.start) / 1000.0;

    timeInfo.delta = (curdate - timeInfo.prev) / 1000.0;

    timeInfo.prev = curdate;



    if(animating) requestAnimationFrame(animate);

    render();

&#125;



function makeCanvasFullScreen(canvas) &#123;

    var b = document.body;

    var d = document.documentElement;

    fullw = Math.max(b.clientWidth , b.scrollWidth, d.scrollWidth, d.clientWidth);

    fullh = Math.max(b.clientHeight , b.scrollHeight, d.scrollHeight, d.clientHeight);

    canvas.width = fullw;

    canvas.height = fullh;

&#125;



window.addEventListener('load', function(e) &#123;

    var canvas = document.getElementById(&quot;sakura&quot;);

    try &#123;

        makeCanvasFullScreen(canvas);

        gl = canvas.getContext('experimental-webgl');

    &#125; catch(e) &#123;

        alert(&quot;WebGL not supported.&quot; + e);

        console.error(e);

        return;

    &#125;



    window.addEventListener('resize', onResize);



    setViewports();

    createScene();

    initScene();



    timeInfo.start = new Date();

    timeInfo.prev = timeInfo.start;

    animate();

&#125;);



//set window.requestAnimationFrame

(function (w, r) &#123;

    w['r'+r] = w['r'+r] || w['webkitR'+r] || w['mozR'+r] || w['msR'+r] || w['oR'+r] || function(c)&#123; w.setTimeout(c, 1000 / 60); &#125;;

&#125;)(window, 'equestAnimationFrame');
</code></pre><p>&lt;/script&gt;<br>&lt;iframe frameborder=&quot;no&quot; border=&quot;0&quot; marginwidth=&quot;0&quot; marginheight=&quot;0&quot; width=300 height=86 src=&quot;<a target="_blank" rel="noopener" href="//music.163.com/outchain/player?type=2&amp;id=1231742&amp;auto=1&amp;height=66">//music.163.com/outchain/player?type=2&amp;id=1231742&amp;auto=1&amp;height=66</a>&quot;&gt;&lt;/iframe&gt;</p><p>&lt;/body&gt;&lt;/html&gt;</p></div><footer><div class="meta"></div><div class="reward"><button><i class="ic i-heartbeat"></i> 赞赏</button><p>请我喝[茶]~(￣▽￣)~*</p><div id="qr"><div><img data-src="/images/wechatpay.png" alt="檐牙 微信支付"><p>微信支付</p></div><div><img data-src="/images/alipay.png" alt="檐牙 支付宝"><p>支付宝</p></div></div></div><div id="copyright"><ul><li class="author"><strong>本文作者： </strong>檐牙 <i class="ic i-at"><em>@</em></i>檐牙的小窝</li><li class="link"><strong>本文链接：</strong> <a href="http://www.zxmacc.cf/sakura/index.html">http://www.zxmacc.cf/sakura/index.html</a></li><li class="license"><strong>版权声明： </strong>本站所有文章除特别声明外，均采用 <span class="exturl" data-url="aHR0cHM6Ly9jcmVhdGl2ZWNvbW1vbnMub3JnL2xpY2Vuc2VzL2J5LW5jLXNhLzQuMC9kZWVkLnpo"><i class="ic i-creative-commons"><em>(CC)</em></i>BY-NC-SA</span> 许可协议。转载请注明出处！</li></ul></div></footer></article></div><div class="wrap" id="comments"></div></div><div id="sidebar"><div class="inner"><div class="panels"><div class="inner"><div class="contents panel pjax" data-title="文章目录"></div><div class="related panel pjax" data-title="系列文章"></div><div class="overview panel" data-title="站点概览"><div class="author" itemprop="author" itemscope itemtype="http://schema.org/Person"><img class="image" itemprop="image" alt="檐牙" data-src="/images/avatar.jpg"><p class="name" itemprop="name">檐牙</p><div class="description" itemprop="description">梦想是当一名画师</div></div><nav class="state"><div class="item posts"><a href="/archives/"><span class="count">4</span> <span class="name">文章</span></a></div><div class="item categories"><a href="/categories/"><span class="count">3</span> <span class="name">分类</span></a></div><div class="item tags"><a href="/tags/"><span class="count">5</span> <span class="name">标签</span></a></div></nav><div class="social"><span class="exturl item github" data-url="aHR0cHM6Ly9naXRodWIuY29tL3p4bWFjYw==" title="https:&#x2F;&#x2F;github.com&#x2F;zxmacc"><i class="ic i-github"></i></span> <span class="exturl item music" data-url="aHR0cHM6Ly9tdXNpYy4xNjMuY29tLyMvdXNlci9ob21lP2lkPXlvdXJpZA==" title="https:&#x2F;&#x2F;music.163.com&#x2F;#&#x2F;user&#x2F;home?id&#x3D;yourid"><i class="ic i-cloud-music"></i></span> <span class="exturl item about" data-url="aHR0cHM6Ly9hYm91dC5tZS95b3VybmFtZQ==" title="https:&#x2F;&#x2F;about.me&#x2F;yourname"><i class="ic i-address-card"></i></span></div><ul class="menu"><li class="item"><a href="/" rel="section"><i class="ic i-home"></i>首页</a></li><li class="item"><a href="/about/" rel="section"><i class="ic i-user"></i>关于</a></li><li class="item dropdown"><a href="javascript:void(0);"><i class="ic i-feather"></i>文章</a><ul class="submenu"><li class="item"><a href="/archives/" rel="section"><i class="ic i-list-alt"></i>归档</a></li><li class="item"><a href="/categories/" rel="section"><i class="ic i-th"></i>分类</a></li><li class="item"><a href="/tags/" rel="section"><i class="ic i-tags"></i>标签</a></li></ul></li><li class="item"><a href="/friends/" rel="section"><i class="ic i-heart"></i>友達</a></li><li class="item"><a href="/links/" rel="section"><i class="ic i-magic"></i>链接</a></li></ul></div></div></div><ul id="quick"><li class="prev pjax"></li><li class="up"><i class="ic i-arrow-up"></i></li><li class="down"><i class="ic i-arrow-down"></i></li><li class="next pjax"></li><li class="percent"></li></ul></div></div><div class="dimmer"></div></div></main><footer id="footer"><div class="inner"><div class="widgets"><div class="rpost pjax"><h2>随机文章</h2><ul><li class="item"><div class="breadcrumb"><a href="/categories/%E6%B5%8B%E8%AF%95/" title="分类于 测试">测试</a></div><span><a href="/posts/28820" title="视频测试（哔哩哔哩视频嵌入）">视频测试（哔哩哔哩视频嵌入）</a></span></li><li class="item"><div class="breadcrumb"></div><span><a href="/posts/4443" title="站点正在建设，请移步blog.zxmacc.cf">站点正在建设，请移步blog.zxmacc.cf</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/%E8%AE%BE%E5%AE%9A/" title="分类于 设定">设定</a></div><span><a href="/posts/19660" title="兽设和人设 （本体设定）">兽设和人设 （本体设定）</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/%E7%95%AA%E5%89%A7/" title="分类于 番剧">番剧</a></div><span><a href="/posts/4439" title="动画番剧推荐（来自深渊）">动画番剧推荐（来自深渊）</a></span></li></ul></div><div><h2>最新评论</h2><ul class="leancloud-recent-comment"></ul></div></div><div class="status"><div class="copyright">&copy; <span itemprop="copyrightYear">2021</span> <span class="with-love"><i class="ic i-Yan ya"></i> </span><span class="author" itemprop="copyrightHolder">檐牙 @ Yan ya</span></div><div class="count"><span class="post-meta-item-icon"><i class="ic i-chart-area"></i> </span><span title="站点总字数">2k 字</span> <span class="post-meta-divider">|</span> <span class="post-meta-item-icon"><i class="ic i-coffee"></i> </span><span title="站点阅读时长">2 分钟</span></div><div class="powered-by">基于 <span class="exturl" data-url="aHR0cHM6Ly9oZXhvLmlv">Hexo</span> & Theme.<span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL2FtZWhpbWUvaGV4by10aGVtZS1zaG9rYQ==">Shoka</span></div></div></div></footer></div><script data-config type="text/javascript">var LOCAL={path:"sakura/",favicon:{show:"（●´3｀●）やれやれだぜ",hide:"(´Д｀)大変だ！"},search:{placeholder:"文章搜索",empty:"关于 「 ${query} 」，什么也没搜到",stats:"${time} ms 内找到 ${hits} 条结果"},valine:!0,fancybox:!0,copyright:'复制成功，转载请遵守 <i class="ic i-creative-commons"></i>BY-NC-SA 协议。',ignores:[function(e){return e.includes("#")},function(e){return new RegExp(LOCAL.path+"$").test(e)}]}</script><script src="https://cdn.polyfill.io/v2/polyfill.js"></script><script src="//cdn.jsdelivr.net/combine/npm/pace-js@1.0.2/pace.min.js,npm/pjax@0.2.8/pjax.min.js,npm/whatwg-fetch@3.4.0/dist/fetch.umd.min.js,npm/animejs@3.2.0/lib/anime.min.js,npm/algoliasearch@4/dist/algoliasearch-lite.umd.js,npm/instantsearch.js@4/dist/instantsearch.production.min.js,npm/lozad@1/dist/lozad.min.js,npm/quicklink@2/dist/quicklink.umd.js"></script><script src="/js/app.js?v=0.2.5"></script></body></html><!-- rebuild by hrmmi -->